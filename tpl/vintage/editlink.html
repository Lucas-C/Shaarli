<!DOCTYPE html>
<html>
<head>{include="includes"}
</head>
<body
{if="$link.title==''"}onload="document.linkform.lf_title.focus();"
{elseif="$link.description==''"}onload="document.linkform.lf_description.focus();"
{else}onload="document.linkform.lf_tags.focus();"{/if} >
{$asyncLoadClass=$link_is_new && $async_metadata && empty($link.title) ? 'loading-input' : ''}
<div id="pageheader">
    {include="page.header"}
    <div id="shaarli_title"><a href="{$titleLink}">{$shaarlititle}</a></div>
    <div id="editlinkform">
        <form method="post" name="linkform" action="{$base_path}/admin/shaare">
          {if="isset($link.id)"}
	          <input type="hidden" name="lf_id" value="{$link.id}">
          {/if}
            <label for="lf_url"><i>URL</i></label><br><input type="text" name="lf_url" id="lf_url" value="{$link.url}" class="lf_input">
            <label for="lf_title"><i>Title</i></label>
            <div class="{$asyncLoadClass}">
              <input type="text" name="lf_title" id="lf_title" value="{$link.title}" class="lf_input">
              <div class="icon-container">
                <i class="loader"></i>
              </div>
            </div>
            <label for="lf_description"><i>Description</i></label>
            <div class="{if="$retrieve_description"}{$asyncLoadClass}{/if}">
              <textarea name="lf_description" id="lf_description" rows="8" cols="25">{$link.description}</textarea>
              <div class="icon-container">
                <i class="loader"></i>
              </div>
            </div>
            <label for="lf_tags"><i>Tags</i></label>
            <div class="{if="$retrieve_description"}{$asyncLoadClass}{/if}">
              <input type="text" name="lf_tags" id="lf_tags" value="{$link.tags}" class="lf_input"
                data-list="{loop="$tags"}{$key}, {/loop}" data-multiple autocomplete="off" >
              <div class="icon-container">
                <i class="loader"></i>
              </div>
            </div>

          {if="$formatter==='markdown'"}
            <div class="md_help">
              {'Description will be rendered with'|t}
              <a href="http://daringfireball.net/projects/markdown/syntax" title="{'Markdown syntax documentation'|t}">
                {'Markdown syntax'|t}
              </a>.
            </div>
          {/if}

          {loop="$edit_link_plugin"}
                {$value}
            {/loop}

            {if="($link_is_new && $default_private_links) || $link.private == true"}
            <input type="checkbox" checked="checked" name="lf_private" id="lf_private">
            &nbsp;<label for="lf_private"><i>Private</i></label><br>
            {else}
            <input type="checkbox"  name="lf_private" id="lf_private">
            &nbsp;<label for="lf_private"><i>Private</i></label><br><br>
            {/if}
            <input type="submit" value="Save" name="save_edit" class="bigbutton">
            {if="!$link_is_new && isset($link.id)"}
              <a href="{$base_path}/admin/shaare/delete?id={$link.id}&amp;token={$token}"
                 name="delete_link" class="bigbutton"
                 onClick="return confirmDeleteLink();">
                {'Delete'|t}
              </a>
            {/if}
            <input type="hidden" name="token" value="{$token}">
            <input type="hidden" name="source" value="{$source}">
            {if="$http_referer"}<input type="hidden" name="returnurl" value="{$http_referer}">{/if}
        </form>
    </div>
</div>
{include="page.footer"}
{if="$link_is_new && $async_metadata"}<script src="{$asset_path}/js/metadata.min.js?v={$version_hash}#"></script>{/if}</body>
{/if}
<script src="inc/awesomplete.min.js#"></script>
<script src="inc/awesomplete-multiple-tags.js#"></script>
<script>
    awesompleteUniqueTag('#lf_tags');


    // auto-add parent tags - Added by Lucas, cf. https://github.com/LeaVerou/awesomplete/blob/v1.0.0/awesomplete.js
    function ajax (args) {
        var xhr = new XMLHttpRequest();
        xhr.open(args.method, args.url, /*async=*/true);
        xhr.onreadystatechange = function () {
            if (xhr.readyState !== 4) { return; }
            if (xhr.status !== 200) { console.error(xhr); return; }
            args.success(xhr.responseText);
        };
        xhr.send(args.data);
    }
    var tags = document.querySelector('#lf_tags');
    ajax({method: 'GET',
          url: 'bookmarks_ordered_hierarchy.json',
          success: function (data) {
        var parentTags = {}
        function populateParentTagsWithNode(node, parentName) {
            for (let k in node) {
                var v = node[k];
                k = k.replace(/ /g, '_');
                if (parentName) { parentTags[k] = parentName; }
                populateParentTagsWithNode(v, k);
            }
        }
        populateParentTagsWithNode(JSON.parse(data));
        var selectedTag;
        tags.addEventListener('awesomplete-select', function(evt) {
            selectedTag = evt.text;
        });
        tags.addEventListener('awesomplete-selectcomplete', function() {
            var tag = selectedTag;
            while (tag = parentTags[tag]) {
                if (!this.value.split(' ').includes(tag)) {
                    awesomplete.replace(tag); // tag is added
                }
            }
        });
    }});
    var description = document.getElementById('lf_description');
    if (!description.value && !tags.value) {
        ajax({method: 'POST',
              url: 'https://chezsoi.org/shaarli/web_page_summarizer',
              data: '{$link.url}',
              success: function (data) {
            var data = JSON.parse(data);
            console.log(data);
            description.value = data.summary_luhn;
            for (let tag of data.tag_suggestions_topia || data.tags_algorithmia || data.tags_opencalais) {
                if (tag.length >= 3) {
                    awesomplete.replace(tag.replace(/ /g, '_')); // tag is added
                }
            }
        }});
    }
</script>
</body>
</html>
